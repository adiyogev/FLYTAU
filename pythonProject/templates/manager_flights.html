<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlyTau Manager - ניהול מערכת</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body class="manager-dashboard">

  <button
    class="btn btn-primary mobile-toggle position-fixed top-0 end-0 m-3 z-3"
    onclick="document.querySelector('.sidebar').classList.toggle('show')">
    <i class="bi bi-list"></i>
  </button>

  <aside class="sidebar">
    <a href="/manager" class="brand-area">
      <span class="brand-text">FLYTAU</span>
      <img src="{{ url_for('static', filename='img/LOGO.png') }}" alt="FLYTAU Logo" class="brand-logo" />
    </a>

    <div class="nav-category">ניהול שוטף</div>
    <nav class="nav flex-column">
      <a href="/manager" class="nav-link active"><i class="bi bi-grid-1x2"></i> לוח טיסות</a>
      <a href="/manager/add_flight/step1" class="nav-link"><i class="bi bi-plus-lg"></i> הוספת טיסה</a>
      <a href="/manager/add_plane" class="nav-link"><i class="bi bi-airplane"></i> הוספת מטוס</a>
      <a href="/manager/add_staff" class="nav-link"><i class="bi bi-people"></i> ניהול צוות</a>
    </nav>

    <div class="nav-category">מערכת</div>
    <nav class="nav flex-column">
      <a href="/manager/reports" class="nav-link"><i class="bi bi-bar-chart"></i> דוחות ניהוליים</a>
      <a href="/logout" class="nav-link text-danger mt-4"><i class="bi bi-box-arrow-right"></i> יציאה</a>
    </nav>
  </aside>

  <main class="main-wrapper">
 {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="custom-flash-alert {{ category }}">
        {% if category == 'success' %}
          <i class="bi bi-check-circle-fill"></i>
        {% else %}
          <i class="bi bi-exclamation-octagon-fill"></i>
        {% endif %}
        {{ message }}
        <button type="button" class="ms-auto border-0 bg-transparent" onclick="this.parentElement.style.display='none';" style="cursor:pointer;">&times;</button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

    <header class="top-header">
      <div class="page-heading">
        <h1>ניהול טיסות</h1>
        <p>סקירה כללית, סטטוסים וניהול לו"ז בזמן אמת</p>
      </div>

      <div class="d-flex align-items-center gap-3">
        <div class="d-flex align-items-center gap-2 bg-white px-3 py-2 rounded-pill border shadow-sm">
          <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold" style="width:32px;height:32px;">
            {{ manager_name[0] | upper if manager_name else 'M' }}
          </div>
          <span class="small fw-bold text-dark">שלום, {{ manager_name or 'מנהל' }}</span>
        </div>
      </div>
    </header>

    <div class="table-container">
      <div class="table-toolbar">
        <h5 class="fw-bold m-0 text-dark">לוח טיסות</h5>
        <form method="GET" action="/manager">
          <select name="status" id="statusFilter" class="filter-select" onchange="this.form.submit()">
            <option value="all" {% if current_filter == 'all' %}selected{% endif %}>הצג הכל</option>
            <option value="active" {% if current_filter == 'active' %}selected{% endif %}>Active (פעילות)</option>
            <option value="full" {% if current_filter == 'full' %}selected{% endif %}>Full (תפוסה מלאה)</option>
            <option value="completed" {% if current_filter == 'completed' %}selected{% endif %}>Completed (הושלמו)</option>
            <option value="cancelled" {% if current_filter == 'cancelled' %}selected{% endif %}>Cancelled (מבוטלות)</option>
          </select>
        </form>
      </div>

      <div class="table-responsive">
        <table class="table" id="flightsTable">
          <thead>
            <tr>
              <th>מזהה (ID)</th>
              <th>נתיב</th>
              <th>מטוס</th>
              <th>המראה</th>
              <th>תפוסה</th>
              <th>סטטוס</th>
              <th class="text-end">פעולות</th>
            </tr>
          </thead>

          <tbody>
            {% if flights %}
              {% for flight in flights %}
                <tr>
                  <td class="font-monospace text-muted">#{{ flight.flight_id }}</td>

                  <td class="route-td">
                    <span class="route-pill" dir="ltr">
                      <strong>{{ flight.origin }}</strong>
                      <span class="route-arrow">→</span>
                      <strong>{{ flight.destination }}</strong>
                    </span>
                  </td>

                  <td>
                    <span class="badge bg-light text-dark border">
                      <i class="bi bi-airplane me-1"></i> {{ flight.plane_id }}
                    </span>
                  </td>

                  <td dir="ltr" style="text-align: right;">
                    {{ flight.departure.strftime('%d/%m/%Y %H:%M') if flight.departure else '-' }}
                  </td>

                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <span>{{ flight.occupied }} / {{ flight.capacity }}</span>
                      {% if flight.capacity and flight.capacity > 0 %}
                        {% set percent = (flight.occupied / flight.capacity * 100) | round | int %}
                      {% else %}
                        {% set percent = 0 %}
                      {% endif %}
                      <div class="progress" style="width: 60px; height: 6px;">
                        <div
                          class="progress-bar bg-{{ 'success' if percent < 80 else 'warning' }}"
                          role="progressbar"
                          style="width: {{ percent }}%">
                        </div>
                      </div>
                    </div>
                  </td>

                  <td>
                    <span class="status-pill st-{{ flight.status | lower }}">
                      {{ flight.status }}
                    </span>
                  </td>

                  <td class="text-end">
                    {% if flight.status | lower != 'cancelled' and flight.status | lower != 'completed'  %}
                      <form method="POST" action="/manager" style="display:inline;">
                        <input type="hidden" name="flight_id" value="{{ flight.flight_id }}">
                        <button
                          type="submit"
                          class="btn-icon danger"
                          title="בטל טיסה"
                          onclick="return confirm('האם אתה בטוח שברצונך לבטל את הטיסה הזו?')">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    {% else %}
                      <span class="text-muted small">-</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center py-5">
                  <div class="text-muted">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    לא נמצאו טיסות התואמות לחיפוש
                  </div>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>