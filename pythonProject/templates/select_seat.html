<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>FLYTAU – בחירת מושבים</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body class="seats-page">

<header>
  <div class="logo">
    <img src="{{ url_for('static', filename='img/LOGO.png') }}" alt="FLYTAU">
  </div>

  <div class="flight-route">
    {{ origin }} <i class="fas fa-plane"></i> {{ dest }}
    <span class="flight-tag">{{ flight_id }}</span>
  </div>
</header>

<div class="plane-container">
  <div class="plane-svg-wrapper">
    <svg class="plane-body-svg" viewBox="0 0 2124 2595.5" preserveAspectRatio="none">
        <defs>
        <linearGradient id="fuselageGradient" x1="0" x2="2124" y1="0" y2="0" gradientUnits="userSpaceOnUse">
        <stop offset="0" stop-color="#ffffff"/>
        <stop offset="0.1" stop-color="#f8fafc"/>
        <stop offset="0.5" stop-color="#ffffff"/>
        <stop offset="0.9" stop-color="#f8fafc"/>
        <stop offset="1" stop-color="#ffffff"/>
        </linearGradient>
        </defs>
        <path d="M1062 0.5C1066.02 0.5 1070.08 2.42708 1074.16 6.06348C1078.24 9.69941 1082.3 15.0103 1086.31 21.6875C1094.34 35.0405 1102.12 53.7668 1109.46 75.2246C1124.14 118.134 1137.01 171.86 1146.51 215.107C1160.81 280.194 1178.31 373.914 1185.41 412.488C1187.56 424.188 1188.62 436.029 1188.62 447.926V1065.01C1188.62 1067.38 1189.42 1069.69 1190.9 1071.54L1214.65 1101.4C1220.7 1109.01 1227.82 1115.69 1235.79 1121.25L1295.34 1162.8L1295.36 1162.82L1295.39 1162.83L2077.95 1589.43C2095.58 1600.66 2128.5 1639.11 2122.86 1704.68C2122.61 1707.59 2119.88 1709.48 2117.15 1708.57C2057.1 1688.65 1627.96 1556.53 1399.47 1486.38C1389.91 1483.44 1380.13 1482 1370.13 1482H1191.5V1986.5C1191.5 2036.18 1182.76 2099.21 1174.01 2149.83C1169.63 2175.14 1165.26 2197.35 1161.98 2213.22C1160.34 2221.16 1158.97 2227.51 1158.02 2231.88C1157.54 2234.07 1157.16 2235.76 1156.91 2236.9C1156.78 2237.47 1156.68 2237.91 1156.61 2238.2C1156.58 2238.34 1156.55 2238.45 1156.54 2238.53C1156.53 2238.56 1156.52 2238.59 1156.52 2238.61C1156.52 2238.62 1156.52 2238.62 1156.52 2238.62L1139.72 2302.37L1139.62 2302.72L1139.92 2302.92L1509.4 2548.86C1510.74 2550.88 1512.47 2555.61 1513.18 2563.26C1513.88 2570.88 1513.57 2581.37 1510.87 2594.88L1093.16 2481.02L1092.67 2480.88L1092.54 2481.37L1089.02 2494.75L1089.02 2494.75C1089.02 2494.75 1089.02 2494.75 1089.02 2494.75C1089.01 2494.75 1089.01 2494.76 1089.01 2494.77C1089.01 2494.79 1089 2494.81 1088.99 2494.84C1088.97 2494.91 1088.94 2495.01 1088.91 2495.14C1088.83 2495.4 1088.72 2495.79 1088.57 2496.28C1088.27 2497.26 1087.82 2498.67 1087.22 2500.35C1086.04 2503.73 1084.27 2508.22 1081.95 2512.71C1079.64 2517.2 1076.78 2521.67 1073.42 2525C1070.07 2528.34 1066.25 2530.5 1062 2530.5C1057.75 2530.5 1053.93 2528.34 1050.58 2525C1047.22 2521.67 1044.36 2517.2 1042.05 2512.71C1039.73 2508.22 1037.9 2503.73 1036.78 2500.35C1036.18 2498.67 1035.73 2497.26 1035.43 2496.28C1035.28 2495.79 1035.17 2495.4 1035.09 2495.14C1035.06 2495.01 1035.03 2494.91 1035.01 2494.84C1035 2494.81 1034.99 2494.79 1034.99 2494.77C1034.99 2494.76 1034.99 2494.75 1034.98 2494.75C1034.98 2494.75 1034.98 2494.75 1034.98 2494.75L1031.46 2481.37L1031.33 2480.89L1030.84 2481.02L611.646 2594.88C608.952 2581.37 608.639 2570.88 609.346 2563.26C610.054 2555.61 611.783 2550.88 613.124 2548.86L984.077 2302.92L984.376 2302.72L984.284 2302.37L967.483 2238.62C967.483 2238.62 967.483 2238.62 967.481 2238.61C967.477 2238.59 967.47 2238.56 967.462 2238.53C967.445 2238.45 967.421 2238.34 967.388 2238.2C967.322 2237.91 967.223 2237.47 967.095 2236.9C966.839 2235.76 966.463 2234.07 965.984 2231.88C965.028 2227.51 963.661 2221.16 962.021 2213.22C958.74 2197.35 954.367 2175.14 949.993 2149.83C941.244 2099.21 932.5 2036.18 932.5 1986.5V1482H753.87C743.874 1482 734.088 1483.44 724.53 1486.38C496.042 1556.53 66.9027 1688.65 6.84863 1708.57C4.11559 1709.48 1.39233 1707.59 1.1416 1704.68C-4.49974 1639.11 28.4212 1600.66 46.0508 1589.43L828.613 1162.83L828.638 1162.82L828.66 1162.8L888.209 1121.25C896.179 1115.69 903.3 1109.01 909.35 1101.4L933.102 1071.54C934.58 1069.69 935.385 1067.38 935.385 1065.01V447.025C935.385 435.724 936.34 424.456 938.305 413.329C945.028 375.253 962.172 280.485 977.487 215.114C987.738 171.361 1000.61 117.634 1015.1 74.8477C1022.35 53.4517 1029.99 34.8195 1037.9 21.5449C1041.85 14.9071 1045.86 9.63246 1049.9 6.02246C1053.94 2.41229 1057.98 0.5 1062 0.5Z" fill="url(#fuselageGradient)" stroke="#9ca3af" stroke-width="1"/>
    </svg>
  </div>

  <div class="cabin-layout">
    {% if biz_map %}
    <div class="section-header header-biz">BUSINESS CLASS</div>
    <div class="class-section">
      {% for row_num, seats in biz_map.items() %}
      <div class="seat-row" style="gap:40px">
        <div class="seat-group">
          {% for s in seats[:2] %}
          <div class="seat biz {% if s.is_occupied %}occupied{% endif %}"
               data-code="{{ s.code }}"
               data-price="{{ s.price }}"
               data-type="business"
               onclick="toggleSeat(this)">
            <i class="fas fa-chair"></i>
          </div>
          {% endfor %}
        </div>
        <span class="row-number">{{ row_num }}</span>
        <div class="seat-group">
          {% for s in seats[2:] %}
          <div class="seat biz {% if s.is_occupied %}occupied{% endif %}"
               data-code="{{ s.code }}"
               data-price="{{ s.price }}"
               data-type="business"
               onclick="toggleSeat(this)">
            <i class="fas fa-chair"></i>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <div class="exit-row"><span>EXIT ROW</span></div>

    {% if eco_map %}
    <div class="section-header header-eco">ECONOMY CLASS</div>
    <div class="class-section">
      {% for row_num, seats in eco_map.items() %}
      <div class="seat-row" style="gap:15px">
        <div class="seat-group">
          {% for s in seats[:3] %}
          <div class="seat eco {% if s.is_occupied %}occupied{% endif %}"
               data-code="{{ s.code }}"
               data-price="{{ s.price }}"
               data-type="economy"
               onclick="toggleSeat(this)">
            <i class="fas fa-chair"></i>
          </div>
          {% endfor %}
        </div>
        <span class="row-number">{{ row_num }}</span>
        <div class="seat-group">
          {% for s in seats[3:] %}
          <div class="seat eco {% if s.is_occupied %}occupied{% endif %}"
               data-code="{{ s.code }}"
               data-price="{{ s.price }}"
               data-type="economy"
               onclick="toggleSeat(this)">
            <i class="fas fa-chair"></i>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
</div>

<div class="legend-panel">
  <div class="legend-title">מקרא מושבים</div>
  <div class="legend-item"><div class="legend-dot dot-biz"></div> עסקים (פנוי)</div>
  <div class="legend-item"><div class="legend-dot dot-eco"></div> תיירים (פנוי)</div>
  <div class="legend-item"><div class="legend-dot dot-occupied"></div> תפוס</div>
  <div class="legend-item"><div class="legend-dot dot-selected"></div> הבחירה שלך</div>
</div>

<div class="price-panel">
  <div class="price-title">סיכום הזמנה</div>
  <div class="passengers-info">
    נוסעים: <span style="color:var(--flytau-teal); font-weight:700;" id="seats-count">0</span> מתוך {{ num_passengers }}
  </div>

  <div class="seat-summary-list" id="seats-list">
    <div style="text-align:center; color:#94a3b8; font-size:14px; padding:20px;">
      טרם נבחרו מושבים
    </div>
  </div>

  <div class="total-row">
    <span style="font-size:16px; font-weight:700; color:#64748b;">סה"כ לתשלום:</span>
    <div class="total-amount">₪<span id="total-price">0</span></div>
  </div>

  <form method="POST" action="/select_seats/{{ flight_id }}" id="seat-form">
    <button type="submit" class="btn-checkout" id="btn-next" disabled>
      המשך לתשלום <i class="fas fa-credit-card"></i>
    </button>
  </form>
</div>

<script>
  // שימי לב: זה הקוד שמפעיל את הבחירה, מעדכן את המחיר ושולח את הטופס
  const maxSeats = {{ num_passengers }};
  let selected = [];

  function toggleSeat(el) {
    if (el.classList.contains('occupied')) return;

    const code = el.getAttribute('data-code');
    const type = el.getAttribute('data-type');
    const price = parseFloat(el.getAttribute('data-price'));

    const index = selected.findIndex(s => s.code === code);

    if (index > -1) {
      selected.splice(index, 1);
      el.classList.remove('selected');
    } else {
      if (selected.length < maxSeats) {
        selected.push({ code, type, price });
        el.classList.add('selected');
      } else {
        alert(`ניתן לבחור מקסימום ${maxSeats} מושבים לנוסעים בהזמנה זו.`);
        return;
      }
    }
    updateUI();
  }

  function updateUI() {
    document.getElementById('seats-count').innerText = selected.length;
    const total = selected.reduce((sum, item) => sum + item.price, 0);
    document.getElementById('total-price').innerText = total.toLocaleString();

    const btn = document.getElementById('btn-next');
    if (selected.length === maxSeats) {
      btn.disabled = false;
      btn.innerHTML = `המשך לתשלום <i class="fas fa-check"></i>`;
      btn.style.background = "var(--flytau-teal)";
    } else {
      btn.disabled = true;
      btn.innerHTML = `נותרו ${maxSeats - selected.length} לבחירה`;
      btn.style.background = "#cbd5e1";
    }

    const list = document.getElementById('seats-list');
    list.innerHTML = '';

    if (selected.length === 0) {
      list.innerHTML = '<div style="text-align:center; color:#94a3b8; font-size:14px; padding:20px;">טרם נבחרו מושבים</div>';
    } else {
      selected.sort((a, b) => a.code.localeCompare(b.code));

      selected.forEach(s => {
        const row = document.createElement('div');
        row.className = 'summary-item';

        const typeLabel = s.type === 'business' ? 'עסקים' : 'תיירים';

        row.innerHTML = `
          <div class="summary-seat-code">${s.code}</div>
          <div class="summary-seat-type">${typeLabel}</div>
          <div class="summary-seat-price">₪${s.price}</div>
        `;
        list.appendChild(row);
      });
    }

    const form = document.getElementById('seat-form');
    // מנקה שדות ישנים לפני הוספה מחדש
    form.querySelectorAll('.hidden-input').forEach(e => e.remove());

    // מייצר שדות נסתרים כדי שהפייתון יוכל לקרוא אותם (request.form)
    selected.forEach(s => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'selected_seats_raw';
      input.className = 'hidden-input';
      input.value = `${s.code}|${s.type}|${s.price}`;
      form.appendChild(input);
    });
  }
</script>

</body>
</html>