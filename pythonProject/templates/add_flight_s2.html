<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLYTAU - הוספת טיסה - שלב 2</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="flight-steps-bg">
    <div class="flight-container">
        <div class="flight-card">
            <h1 class="page-title">הוספת טיסה חדשה - שלב 2</h1>

            <div class="step-indicator">
                <div class="step">1. פרטים בסיסיים</div>
                <div class="step active">2. משאבים</div>
                <div class="step">3. תמחור</div>
            </div>

            {% if error %}
            <div class="error-message"><i class="fas fa-exclamation-circle"></i> {{ error }}</div>
            {% endif %}

            <form method="POST" action="/manager/add_flight/step2" id="step2-form">

                <div class="section-title"><i class="fas fa-plane"></i> בחר מטוס</div>
                <div class="resource-grid">
                    {% for plane in planes %}
                    <label class="resource-item">
                        <input type="radio" name="plane_id" value="{{ plane[0] }}" data-size="{{ plane[1] }}" style="display:none;">
                        <div class="resource-id">מטוס #{{ plane[0] }}</div>
                        <div class="resource-details">גודל: <strong>{{ plane[1] }}</strong></div>
                    </label>
                    {% endfor %}
                </div>

                <div class="section-title">
                    <i class="fas fa-user-tie"></i> בחר טייסים
                    <span id="pilot-req-text" class="req-badge">בחר מטוס כדי לראות דרישות</span>
                </div>
                <div class="resource-grid">
                    {% for pilot in pilots %}
                    <label class="resource-item">
                        <input type="checkbox" name="pilots" value="{{ pilot[0] }}" style="display:none;">
                        <div class="resource-id">טייס #{{ pilot[0] }}</div>
                        <div class="resource-details">{{ pilot[1] }} {{ pilot[2] }}</div>
                    </label>
                    {% endfor %}
                </div>

                <div class="section-title">
                    <i class="fas fa-user-friends"></i> בחר דיילים
                    <span id="fa-req-text" class="req-badge">בחר מטוס כדי לראות דרישות</span>
                </div>
                <div class="resource-grid">
                    {% for fa in fas %}
                    <label class="resource-item">
                        <input type="checkbox" name="fas" value="{{ fa[0] }}" style="display:none;">
                        <div class="resource-id">דייל #{{ fa[0] }}</div>
                        <div class="resource-details">{{ fa[1] }} {{ fa[2] }}</div>
                    </label>
                    {% endfor %}
                </div>

                <div class="actions">
                    <a href="/manager/add_flight/step1" class="btn-secondary">חזור</a>
                    <button type="submit" class="btn-primary">המשך לתמחור <i class="fas fa-arrow-left"></i></button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let requiredPilots = 0;
            let requiredFas = 0;

            // --- 1. טיפול בבחירת מטוס (Radio Buttons) ---
            const planeRadios = document.querySelectorAll('input[name="plane_id"]');

            planeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    // הסרת סימון מכל המטוסים
                    document.querySelectorAll('input[name="plane_id"]').forEach(r => {
                        r.closest('.resource-item').classList.remove('selected');
                    });

                    // סימון המטוס שנבחר
                    if(this.checked) {
                        this.closest('.resource-item').classList.add('selected');

                        // עדכון דרישות לפי הגודל
                        const size = this.getAttribute('data-size');
                        if (size === 'large') {
                            requiredPilots = 3;
                            requiredFas = 6;
                        } else {
                            requiredPilots = 2;
                            requiredFas = 3;
                        }

                        // עדכון הטקסט למשתמש
                        document.getElementById('pilot-req-text').innerText = `יש לבחור בדיוק ${requiredPilots} טייסים`;
                        document.getElementById('fa-req-text').innerText = `יש לבחור בדיוק ${requiredFas} דיילים`;
                    }
                });
            });

            // --- 2. טיפול בבחירת צוות (Checkboxes) ---
            // פונקציה שמאזינה לשינוי בתיבת הסימון עצמה
            const crewCheckboxes = document.querySelectorAll('input[type="checkbox"]');

            crewCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const card = this.closest('.resource-item');

                    if (this.checked) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                });
            });

            // --- 3. בדיקות תקינות לפני שליחה (Validation) ---
            document.getElementById('step2-form').addEventListener('submit', function(e) {
                // ספירה בזמן אמת של מה שנבחר
                const selectedPilots = document.querySelectorAll('input[name="pilots"]:checked').length;
                const selectedFas = document.querySelectorAll('input[name="fas"]:checked').length;

                // בדיקה אם נבחר מטוס בכלל
                const isPlaneSelected = document.querySelector('input[name="plane_id"]:checked');

                if (!isPlaneSelected) {
                    e.preventDefault();
                    alert("אנא בחר מטוס תחילה.");
                    return;
                }

                if (selectedPilots !== requiredPilots || selectedFas !== requiredFas) {
                    e.preventDefault();
                    alert(`שגיאה בבחירת הצוות!\n\nעבור המטוס שבחרת נדרשים:\n- ${requiredPilots} טייסים (בחרת ${selectedPilots})\n- ${requiredFas} דיילים (בחרת ${selectedFas})`);
                }
            });
        });
    </script>
</body>
</html>