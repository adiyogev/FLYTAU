<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlyTau Manager - דוחות ניהוליים</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-body:#eef6ff;
      --sidebar-width:260px;
      --text-dark:#0f172a;
      --text:#1e293b;
      --muted:#64748b;
      --border:rgba(226,232,240,.9);
      --radius:16px;
      --shadow: 0 18px 55px rgba(15,23,42,.12);
    }

    body{
      font-family:'Heebo',sans-serif;
      color:var(--text);
      overflow-x:hidden;
      background:
        radial-gradient(900px 260px at 85% 0%, rgba(14,165,233,.14), transparent 60%),
        radial-gradient(720px 240px at 15% 0%, rgba(20,184,166,.12), transparent 55%),
        var(--bg-body);
    }

    .sidebar{
      position:fixed; top:0; right:0;
      height:100vh; width:var(--sidebar-width);
      padding:16px 0; z-index:1000;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-left:1px solid var(--border);
      box-shadow: 0 20px 60px rgba(15,23,42,.06);
      display:flex; flex-direction:column;
    }

    .brand-area{
      padding: 14px 22px 12px;
      display:flex; align-items:center; gap:12px;
      font-size:1.35rem; font-weight:900;
      color:var(--text-dark); text-decoration:none;
      border-bottom: 1px solid var(--border);
    }
    .brand-area:hover{ color:var(--text-dark); }
    .brand-logo{ width:78px; height:58px; object-fit:contain; }

    .nav-category{
      padding: 12px 22px 6px;
      font-weight:800; font-size:.78rem;
      letter-spacing:.5px; text-transform:uppercase;
      color:#94a3b8;
    }

    .nav-link{
      margin:2px 12px;
      border-radius:12px;
      padding:12px 12px;
      display:flex; align-items:center; gap:10px;
      color:#334155;
      border:1px solid transparent;
      transition:.18s ease;
      text-decoration:none;
    }
    .nav-link i{ color:#64748b; font-size:1.05rem; }
    .nav-link:hover{
      background: rgba(241,245,249,.9);
      transform: translateX(-2px);
      border-color: rgba(226,232,240,.9);
      color: var(--text-dark);
    }
    .nav-link.active{
      background: rgba(224,242,254,.70);
      color:#075985;
      font-weight:900;
      box-shadow: 0 10px 20px rgba(2,132,199,.10);
      border-color: rgba(2,132,199,.18);
    }
    .nav-link.active i{ color:#0284c7; }

    .main-wrapper{
      margin-right: var(--sidebar-width);
      padding: 40px;
    }

    .top-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:16px;
      flex-wrap:wrap;
      margin-bottom: 22px;
    }

    .page-heading h1{
      font-size:1.85rem;
      font-weight:900;
      color:var(--text-dark);
      margin:0 0 6px;
      letter-spacing:-.8px;
    }
    .page-heading p{
      margin:0;
      color:var(--muted);
      max-width:60ch;
    }

    .surface{
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(226,232,240,.85);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* KPI grid - always 4 in a row on desktop */
    .stats-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 18px;
      margin-bottom: 26px;
    }

    .kpi-box{
      background: white;
      border-radius: 14px;
      padding: 18px;
      text-align: center;
      border: 1px solid rgba(226,232,240,.9);
      box-shadow: 0 8px 20px rgba(15,23,42,.08);
    }

    .kpi-label{
      color:#64748b;
      font-weight:700;
      font-size:.85rem;
    }

    .kpi-value{
      font-size:2rem;
      font-weight:900;
      color:#0f172a;
      margin-top:6px;
    }

    /* Charts */
    .charts-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      margin-bottom: 18px;
    }

    /* ✅ שינוי עיקרי: כרטיס גרף עם גובה קבוע */
    .chart-wrap{
      padding: 22px;
      height: 560px;              /* פריסה מלאה בכרטיס */
      display:flex;
      flex-direction:column;
    }

    .chart-title{
      font-size: 1.55rem;
      font-weight: 900;
      color: var(--text-dark);
      text-align: center;
      margin: 4px 0 6px;
      letter-spacing: -0.6px;
    }

    .chart-subtitle{
      text-align:center;
      color: var(--muted);
      margin: 0 0 14px;
    }

    /* ✅ אזור שמחזיק את התמונה ונותן לה להימתח */
    .chart-area{
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ✅ התמונה ממלאת את הגובה בלי max-height שמקטין */
    .chart-img{
      width: 100%;
      height: 100%;
      max-height: none;
      object-fit: contain;
      display:block;
    }

    /* Table card */
    .card-head{
      padding: 16px 20px;
      border-bottom: 1px solid rgba(226,232,240,.85);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background: linear-gradient(180deg, rgba(248,250,252,1), rgba(255,255,255,1));
    }

    .table th{
      background: rgba(248,250,252,.95) !important;
      font-weight:900;
      font-size:.78rem;
      text-transform:uppercase;
      color:#475569;
      border-bottom: 1px solid rgba(226,232,240,.9) !important;
      white-space: nowrap;
    }
    .table td{
      border-bottom: 1px solid rgba(226,232,240,.75) !important;
      vertical-align: middle;
    }

    @media(max-width: 992px){
      .main-wrapper{ margin-right: 0; padding: 20px; }
      .sidebar{ display:none; }
      .stats-grid{ grid-template-columns: repeat(2, 1fr); }
      .charts-grid{ grid-template-columns: 1fr; }
      .chart-wrap{ height: 520px; } /* קצת קטן יותר במובייל */
    }
  </style>
</head>

<body>

  <aside class="sidebar">
    <a href="/manager" class="brand-area">
      <span>FLYTAU</span>
      <!-- ✅ לוגו לפי התיקיות -->
      <img src="{{ url_for('static', filename='img/LOGO.png') }}" alt="FLYTAU Logo" class="brand-logo">
    </a>

    <div class="nav-category">ניהול שוטף</div>
    <nav class="nav flex-column">
      <a href="/manager" class="nav-link"><i class="bi bi-grid-1x2"></i> לוח טיסות</a>
      <a href="/manager/add_flight/step1" class="nav-link"><i class="bi bi-plus-lg"></i> הוספת טיסה</a>
      <a href="/manager/add_plane" class="nav-link"><i class="bi bi-airplane"></i> הוספת מטוס</a>
      <a href="/manager/add_staff" class="nav-link"><i class="bi bi-people"></i> ניהול צוות</a>
    </nav>

    <div class="nav-category">מערכת</div>
    <nav class="nav flex-column">
      <a href="/manager/reports" class="nav-link active"><i class="bi bi-bar-chart"></i> דוחות ניהוליים</a>
      <a href="/logout" class="nav-link text-danger mt-4"><i class="bi bi-box-arrow-right"></i> יציאה</a>
    </nav>
  </aside>

  <main class="main-wrapper">
    <header class="top-header">
      <div class="page-heading">
        <h1>דוחות ניהוליים</h1>
        <p>סקירה מהירה של ביצועי המערכת והצגת גרפים מתוך נתוני ההזמנות</p>
      </div>

      <a href="/manager" class="btn btn-outline-primary rounded-pill px-3">
        <i class="bi bi-arrow-right"></i> חזרה ללוח טיסות
      </a>
    </header>

    <section class="stats-grid">
      <div class="kpi-box">
        <div class="kpi-label">סה״כ הזמנות</div>
        <div class="kpi-value">{{ total_orders }}</div>
      </div>

      <div class="kpi-box">
        <div class="kpi-label">הכנסות</div>
        <div class="kpi-value">₪{{ total_revenue }}</div>
      </div>

      <div class="kpi-box">
        <div class="kpi-label">ביטולים</div>
        <div class="kpi-value">{{ cancelled_orders }}</div>
      </div>

      <div class="kpi-box">
        <div class="kpi-label"> תפוסה ממוצעת בטיסות</div>
        <div class="kpi-value">{{ "%.1f"|format(avg_total_occupancy) }}%</div>
      </div>
    </section>

    <!-- CHARTS -->
    <section class="charts-grid">
      <div class="surface chart-wrap">
        <div class="chart-title">שיעור ביטולים חודשי</div>
        <div class="chart-subtitle">( 12 חודשים אחרונים)</div>

        <!-- ✅ עטיפה שמאפשרת לתמונה להימתח לאורך הכרטיס -->
        <div class="chart-area">
          <img
            class="chart-img"
            src="{{ url_for('static', filename='reports/cancellation_rate.png') }}?v={{ total_orders }}"
            alt="Monthly Cancellation Rate Bar Chart">
        </div>
      </div>

      <div class="surface chart-wrap">
        <div class="chart-title">תפוסה ממוצעת</div>

        <div class="chart-area">
          <img
            class="chart-img"
            src="{{ url_for('static', filename='reports/avg_occupancy.png') }}?v={{ total_orders }}"
            alt="Average Occupancy Donut Chart">
        </div>
      </div>
    </section>

    <!-- TOP ROUTES TABLE -->
    <section class="surface">
      <div class="card-head">
        <div class="fw-bold text-dark">Top 5 Routes</div>
      </div>

      <div class="table-responsive">
        <table class="table mb-0">
          <thead>
            <tr>
              <th>מקור</th>
              <th>יעד</th>
              <th class="text-end">כמות</th>
            </tr>
          </thead>
          <tbody>
            {% if top_routes and top_routes|length > 0 %}
              {% for r in top_routes %}
                <tr>
                  <td><strong>{{ r[0] }}</strong></td>
                  <td><strong>{{ r[1] }}</strong></td>
                  <td class="text-end">{{ r[2] }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="3" class="text-center py-5 text-muted">
                  <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                  אין נתונים להצגה כרגע
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
