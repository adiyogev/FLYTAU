<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlyTau Manager - ניהול מערכת ודוחות</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --flytau-navy: #001b33;
            --flytau-teal: #00818a;
            --bg-light: #f1f5f9;
            --white: #ffffff;
            --purple-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Heebo', sans-serif;
            background-color: var(--bg-light);
            color: var(--flytau-navy);
            margin: 0; padding-bottom: 50px;
        }

        /* Navbar */
        .navbar {
            background: var(--white);
            padding: 10px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            position: sticky; top: 0; z-index: 1000;
        }
        .navbar-brand img { height: 65px; object-fit: contain; }
        .nav-link-custom {
            color: var(--flytau-navy); font-weight: 700; text-decoration: none;
            font-size: 15px; display: flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .nav-link-custom:hover, .nav-link-custom.active { color: var(--flytau-teal); }

        /* Hero & Stats */
        .hero-banner {
            background: var(--purple-gradient); border-radius: 24px;
            padding: 45px; color: white; text-align: center;
            margin: 25px 40px; box-shadow: 0 15px 35px rgba(99, 102, 241, 0.2);
        }
        .stats-grid {
            padding: 0 40px; display: grid;
            grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: var(--white); border-radius: 20px; padding: 24px;
            box-shadow: var(--card-shadow); display: flex;
            justify-content: space-between; align-items: flex-start;
        }
        .stat-content .value { font-size: 32px; font-weight: 900; line-height: 1; margin-bottom: 8px; }
        .stat-icon-box {
            width: 54px; height: 54px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
        }

        /* Charts & Table */
        .dashboard-main { padding: 0 40px; display: grid; grid-template-columns: 1fr 1.8fr; gap: 20px; margin-bottom: 30px; }
        .chart-container { background: var(--white); padding: 30px; border-radius: 24px; box-shadow: var(--card-shadow); }

        .progress { background-color: #e9ecef; border-radius: 10px; overflow: hidden; }
        .progress-bar { background-color: var(--flytau-teal); }

        .table-section { margin: 0 40px; background: white; border-radius: 24px; padding: 30px; box-shadow: var(--card-shadow); }
    </style>
</head>
<body>

    <nav class="navbar d-flex justify-content-between">
        <div class="d-flex align-items-center">
            <a class="navbar-brand" href="/manager">
                <img src="{{ url_for('static', filename='LOGO.jpeg') }}" alt="FLYTAU Logo">
            </a>
            <div class="ms-5 d-flex gap-4">
                <a href="/manager" class="nav-link-custom active"><i class="bi bi-grid-1x2"></i> ניהול טיסות</a>
                <a href="/manager/add_flight/step1" class="nav-link-custom"><i class="bi bi-plus-circle"></i> הוספת טיסה</a>
                <a href="/manager/add_staff" class="nav-link-custom"><i class="bi bi-people"></i> ניהול צוות</a>
            </div>
        </div>
        <a href="/logout" class="nav-link-custom text-danger"><i class="bi bi-box-arrow-right"></i> התנתק</a>
    </nav>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-success mx-5 mt-3 text-center fw-bold" style="border-radius: 15px;">
              {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="hero-banner">
        <h1>שלום, מנהל המערכת</h1>
        <p>סקירת ביצועים, ניהול תפוסה ולוח טיסות בזמן אמת</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-content">
                <h6>סה"כ עובדים</h6>
                <div class="value">{{ total_staff }}</div>
            </div>
            <div class="stat-icon-box" style="background: #fff7ed; color: #f97316;"><i class="bi bi-people"></i></div>
        </div>
        <div class="stat-card">
            <div class="stat-content">
                <h6>הכנסות</h6>
                <div class="value">₪{{ "{:,.0f}".format(total_income) }}</div>
            </div>
            <div class="stat-icon-box" style="background: #f0fdf4; color: #22c55e;"><i class="bi bi-cash-stack"></i></div>
        </div>
        <div class="stat-card">
            <div class="stat-content">
                <h6>טיסות פעילות</h6>
                <div class="value">{{ flights|selectattr('is_cancelled', 'equalto', false)|list|length }}</div>
            </div>
            <div class="stat-icon-box" style="background: #eff6ff; color: #3b82f6;"><i class="bi bi-airplane"></i></div>
        </div>
        <div class="stat-card">
            <div class="stat-content">
                <h6>סה"כ הזמנות</h6>
                <div class="value">{{ total_orders }}</div>
            </div>
            <div class="stat-icon-box" style="background: #faf5ff; color: #a855f7;"><i class="bi bi-ticket-perforated"></i></div>
        </div>
    </div>

    <div class="dashboard-main">
        <div class="chart-container">
            <h5>סטטוס טיסות</h5>
            <canvas id="statusChart"></canvas>
        </div>
        <div class="chart-container">
            <h5>הכנסות לפי יעד</h5>
            <canvas id="incomeChart"></canvas>
        </div>
    </div>

    <div class="table-section mb-5">
        <h5 class="mb-4 fw-bold">לוח טיסות מפורט</h5>
        <table class="table align-middle">
            <thead class="table-light">
                <tr>
                    <th>טיסה</th><th>נתיב</th><th>המראה</th><th>תפוסה</th><th>סטטוס</th><th>פעולה</th>
                </tr>
            </thead>
            <tbody>
                {% for flight in flights %}
                <tr>
                    <td class="fw-bold">#{{ flight.flight_id }}</td>
                    <td>{{ flight.origin }} <i class="bi bi-arrow-left"></i> {{ flight.destination }}</td>
                    <td dir="ltr">{{ flight.departure.strftime('%d/%m/%Y %H:%M') if flight.departure else '-' }}</td>
                    <td>
                        {% set pct = (flight.occupied / flight.capacity * 100)|int if flight.capacity > 0 else 0 %}
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress flex-grow-1" style="height: 8px;">
                                <div class="progress-bar" style="width: {{ pct }}%"></div>
                            </div>
                            <small class="fw-bold">{{ pct }}%</small>
                        </div>
                        <small class="text-muted">{{ flight.occupied }} / {{ flight.capacity }} מושבים</small>
                    </td>
                    <td>
                        <span class="badge {% if flight.status == 'active' %}bg-success{% elif flight.status == 'cancelled' %}bg-danger{% else %}bg-secondary{% endif %}">
                            {{ flight.status }}
                        </span>
                    </td>
                    <td>
                        {% if flight.status == 'active' %}
                        <form method="POST" action="/manager" onsubmit="return confirm('לבטל טיסה?')">
                            <input type="hidden" name="flight_id" value="{{ flight.flight_id }}">
                            <button class="btn btn-sm btn-outline-danger">בטל טיסה</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        const ctxStatus = document.getElementById('statusChart').getContext('2d');
        new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: Object.keys({{ status_dict|tojson }}),
                datasets: [{
                    data: Object.values({{ status_dict|tojson }}),
                    backgroundColor: ['#22c55e', '#ef4444', '#3b82f6', '#f97316']
                }]
            }
        });

        const ctxIncome = document.getElementById('incomeChart').getContext('2d');
        new Chart(ctxIncome, {
            type: 'bar',
            data: {
                labels: {{ dest_labels|tojson }},
                datasets: [{
                    label: 'הכנסה בש"ח',
                    data: {{ dest_values|tojson }},
                    backgroundColor: '#6366f1',
                    borderRadius: 8
                }]
            }
        });
    </script>
</body>
</html>